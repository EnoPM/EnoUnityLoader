<?xml version="1.0" encoding="utf-8"?>
<!--
  Target pour copier les assemblies vers les dossiers core et mods du ModLoader.
  Ce fichier peut être importé séparément des props pour les projets
  qui ont leur propre configuration de build (ex: MonoMod).

  Usage:
  <Import Project="$(MSBuildThisFileDirectory)..\..\build\EnoModLoader.CopyToGameFiles.targets" />
-->
<Project>

  <PropertyGroup>
    <!-- Lire ModLoaderOutputPath depuis Directory.Build.props à la racine -->
    <ModLoaderOutputPath Condition="'$(ModLoaderOutputPath)' == ''">$(MSBuildThisFileDirectory)..\output\ModLoader</ModLoaderOutputPath>
    <CoreOutputPath Condition="'$(CoreOutputPath)' == ''">$(ModLoaderOutputPath)\core</CoreOutputPath>
    <UiOutputPath Condition="'$(UiOutputPath)' == ''">$(CoreOutputPath)\ui</UiOutputPath>
    <ModsOutputPath Condition="'$(ModsOutputPath)' == ''">$(ModLoaderOutputPath)\mods</ModsOutputPath>
    <PluginsPatcherOutputPath Condition="'$(PluginsPatcherOutputPath)' == ''">$(ModLoaderOutputPath)\patchers\plugins</PluginsPatcherOutputPath>
    <CopyToMods Condition="'$(CopyToMods)' == ''">false</CopyToMods>
    <CopyToCore Condition="'$(CopyToCore)' == ''">false</CopyToCore>
    <CopyToUi Condition="'$(CopyToUi)' == ''">false</CopyToUi>
    <CopyToPluginsPatcher Condition="'$(CopyToPluginsPatcher)' == ''">false</CopyToPluginsPatcher>
    <CopyAllDependenciesToCore Condition="'$(CopyAllDependenciesToCore)' == ''">false</CopyAllDependenciesToCore>
  </PropertyGroup>

  <!--
    Copy DLL to patchers/plugins folder after build.
  -->
  <Target Name="CopyToPluginsPatcher" AfterTargets="AfterBuild" Condition="'$(CopyToPluginsPatcher)' == 'true'">
    <MakeDir Directories="$(PluginsPatcherOutputPath)" Condition="!Exists('$(PluginsPatcherOutputPath)')" />
    <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(PluginsPatcherOutputPath)" SkipUnchangedFiles="false" />
    <Message Importance="High" Text="Copied $(TargetFileName) to $(PluginsPatcherOutputPath)" />
  </Target>
  
  <!--
    Copy DLL to mods folder after build.
  -->
  <Target Name="CopyToMods" AfterTargets="AfterBuild" Condition="'$(CopyToMods)' == 'true'">
    <MakeDir Directories="$(ModsOutputPath)" Condition="!Exists('$(ModsOutputPath)')" />
    <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(ModsOutputPath)" SkipUnchangedFiles="true" />
    <Message Importance="High" Text="Copied $(TargetFileName) to $(ModsOutputPath)" />
  </Target>

  <!--
    Copy DLL to core folder after build.
  -->
  <Target Name="CopyToCore" AfterTargets="AfterBuild" Condition="'$(CopyToCore)' == 'true' and '$(CopyAllDependenciesToCore)' != 'true'">
    <MakeDir Directories="$(CoreOutputPath)" Condition="!Exists('$(CoreOutputPath)')" />
    <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(CoreOutputPath)" SkipUnchangedFiles="true" />
    <Message Importance="High" Text="Copied $(TargetFileName) to $(CoreOutputPath)" />
  </Target>

  <!--
    Copy all DLLs (including dependencies) to core folder.
    Use CopyAllDependenciesToCore=true on the main project (EnoModLoader).
  -->
  <Target Name="CopyAllToCore" AfterTargets="AfterBuild" Condition="'$(CopyAllDependenciesToCore)' == 'true'">
    <MakeDir Directories="$(CoreOutputPath)" Condition="!Exists('$(CoreOutputPath)')" />
    <ItemGroup>
      <DllsToCopy Include="$(TargetDir)*.dll" />
    </ItemGroup>
    <Copy SourceFiles="@(DllsToCopy)" DestinationFolder="$(CoreOutputPath)" SkipUnchangedFiles="true" />
    <Message Importance="High" Text="Copied @(DllsToCopy->Count()) DLLs to $(CoreOutputPath)" />
  </Target>

  <!--
    Copy UI exe to core/ui folder after publish.
    Use CopyToUi=true on the UI project.
    For single-file self-contained apps, this copies from the publish folder.
  -->
  <Target Name="CopyToUi" AfterTargets="Publish" Condition="'$(CopyToUi)' == 'true'">
    <MakeDir Directories="$(UiOutputPath)" Condition="!Exists('$(UiOutputPath)')" />
    <ItemGroup>
      <UiFilesToCopy Include="$(PublishDir)**\*.*" />
    </ItemGroup>
    <Copy SourceFiles="@(UiFilesToCopy)" DestinationFolder="$(UiOutputPath)\%(RecursiveDir)" SkipUnchangedFiles="true" />
    <Message Importance="High" Text="Copied @(UiFilesToCopy->Count()) files to $(UiOutputPath)" />
  </Target>

</Project>
