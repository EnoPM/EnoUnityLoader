name: Build and Release

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        default: 'true'
        type: boolean

env:
  DOTNET_VERSION: '10.0.x'
  CONFIGURATION: Release

jobs:
  build-and-release:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore EnoUnityLoader
        env:
          GITHUB_TOKEN: ${{ secrets.NUGET_GITHUB_TOKEN }}
        run: dotnet restore EnoUnityLoader/EnoUnityLoader.csproj

      - name: Restore EnoUnityLoader.AutoInterop
        env:
          GITHUB_TOKEN: ${{ secrets.NUGET_GITHUB_TOKEN }}
        run: dotnet restore EnoUnityLoader.AutoInterop/EnoUnityLoader.AutoInterop.csproj

      - name: Build EnoUnityLoader
        run: dotnet build EnoUnityLoader/EnoUnityLoader.csproj -c ${{ env.CONFIGURATION }} --no-restore "-p:SolutionDir=${{ github.workspace }}/" -p:CopyToCore=false -p:CopyAllDependenciesToCore=false

      - name: Build EnoUnityLoader.AutoInterop
        run: dotnet build EnoUnityLoader.AutoInterop/EnoUnityLoader.AutoInterop.csproj -c ${{ env.CONFIGURATION }} --no-restore "-p:SolutionDir=${{ github.workspace }}/" -p:CopyToPluginsPatcher=false

      - name: Get version from csproj
        id: get_version
        shell: pwsh
        run: |
          [xml]$csproj = Get-Content "EnoUnityLoader/EnoUnityLoader.csproj"
          $version = $csproj.Project.PropertyGroup.Version | Where-Object { $_ -ne $null } | Select-Object -First 1
          if (-not $version) {
            $version = "1.0.0"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Detected version: $version"

      - name: Create release structure
        shell: pwsh
        run: |
          # Create directory structure
          New-Item -ItemType Directory -Force -Path "release/EnoUnityLoader/core"
          New-Item -ItemType Directory -Force -Path "release/EnoUnityLoader/patchers/plugins"
          New-Item -ItemType Directory -Force -Path "release/EnoUnityLoader/mods"

          # Copy EnoUnityLoader and all dependencies to core folder
          $corePath = "EnoUnityLoader/bin/${{ env.CONFIGURATION }}/net10.0"
          Get-ChildItem -Path $corePath -Filter "*.dll" | Copy-Item -Destination "release/EnoUnityLoader/core" -Force

          # Copy runtimes folder if it exists
          $runtimesPath = "$corePath/runtimes"
          if (Test-Path $runtimesPath) {
            Copy-Item -Path $runtimesPath -Destination "release/EnoUnityLoader/core/runtimes" -Recurse -Force
          }

          # Copy AutoInterop to patchers/plugins
          Copy-Item -Path "EnoUnityLoader.AutoInterop/bin/${{ env.CONFIGURATION }}/net10.0/EnoUnityLoader.AutoInterop.dll" -Destination "release/EnoUnityLoader/patchers/plugins" -Force

      - name: Extract additional files from archive
        shell: pwsh
        run: |
          # Check if additional files archive exists
          $archivePath = "release-extras.zip"
          if (Test-Path $archivePath) {
            echo "Found additional files archive, extracting..."
            Expand-Archive -Path $archivePath -DestinationPath "release" -Force
          } else {
            echo "No additional files archive found at $archivePath"
          }

      - name: Create release archive
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          Compress-Archive -Path "release/*" -DestinationPath "EnoUnityLoader-v$version.zip" -Force

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: EnoUnityLoader-v${{ steps.get_version.outputs.version }}
          path: EnoUnityLoader-v${{ steps.get_version.outputs.version }}.zip

      - name: Create Release if not exists
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $tag = "v$version"
          $archiveName = "EnoUnityLoader-v$version.zip"

          # Check if release exists (suppress errors)
          $ErrorActionPreference = "SilentlyContinue"
          gh release view $tag 2>$null
          $releaseExists = $LASTEXITCODE -eq 0
          $ErrorActionPreference = "Stop"

          if ($releaseExists) {
            echo "Release $tag already exists, skipping creation"
          } else {
            echo "Creating release $tag"
            gh release create $tag `
              --title "EnoUnityLoader v$version" `
              --notes "Release of EnoUnityLoader version $version" `
              --draft=false `
              $archiveName

            if ($LASTEXITCODE -eq 0) {
              echo "Release $tag created successfully"
            } else {
              echo "Failed to create release $tag"
              exit 1
            }
          }
